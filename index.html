<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- Bootstrap -->
    <!-- Bootstrap -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">
    <title>Maps POC</title>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!--<script src="NoSleep.js"></script>-->
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #mapPlotting {
            height: 100%;
        }
        
        .navbar-brand {
            font-size: 15px;
        }
        
        .btn-links {
            color: #04b2ff;
            background-color: #fff;
            border: solid 2px #04b2ff;
        }
        
        .navbar-header {
            padding-top: 8px;
        }
        
        .from-location-input {
            margin-left: 25px;
            display: inline;
            width: 82%;
            margin-top: 5px;
        }
        
        .to-location-input {
            margin-left: 43px;
            display: inline;
            width: 82%;
            margin-top: 5px;
        }
        
        .latlong-input {
            display: inline;
            margin-top: 5px;
            width: 33%;
        }
        
        .grid-input {
            display: inline;
            width: 50%;
        }
        
        #btnGetRegion {
            margin-left: 20%;
        }
        
        #btnMapTrip {
            margin-left: 71px;
        }
    </style>

</head>

<body>

    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false"
                    aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Mapping POC -</a>
                <a class="navbar-brand" href="#">User = <%= Session["User"]!=null?Session["User"].ToString():string.Empty %></a>
                <a class="navbar-brand" href="#" id="locationRef">Location=19.20,17.222</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#">
                            <button type="button" id="btnMapPlotting" class="btn  btn-links">Map Plotting</button></a>
                    </li>
                    <li>
                        <a href="#">
                            <button type="button" id="btnSingleTrip" class="btn  btn-links">Single Trip</button></a>
                    </li>
                    <li>
                        <a href="#">
                            <button type="button" id="btnGrid" class="btn  btn-links">Grid</button></a>
                    </li>
                    <li>
                        <a href="logoff.aspx">
                            <button type="button" id="btnLogout" class="btn  btn-links">Logout</button></a>
                    </li>
                </ul>
            </div>

        </div>
    </nav>

    <div class="container theme-showcase" role="main">
        <div class="container" style="margin-top: 105px;">
            <div class="row" id="mapPlottingPin" style="display: none;">
                <div class="col-md-12" id="selectePin">
                </div>
            </div>
            <div id="singleTrip" style="display: none;">
                <form class="form-horizontal">
                    <div class="form-group">
                        <div class="control-label col-sm-2">From Location:</div>
                        <div class="col-sm-10">
                            <input type="text" class="form-control " id="fromLocation" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="control-label col-sm-2">To Location:</div>
                        <div class="col-sm-10">
                            <input type="text" class="form-control " id="toLocation" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="control-label col-sm-2">Or: From Lat/Long:</div>
                        <div class="col-sm-3">
                            <input type="text" class="form-control " id="fromLatLong" placeholder="">
                        </div>
                        <div class="control-label col-sm-1">To:</div>
                        <div class="col-sm-3">
                            <input type="text" class="form-control " id="toLatLong" placeholder="">
                        </div>
                        <button type="button" class="btn btn-success  col-sm-1" id="btnMapTrip">Map Trip</button>
                    </div>
                    <div class="form-group">
                        <div class="control-label col-sm-4" id="singleTripTime" style="display: none;">Expected Trip Time = </div>
                    </div>
                </form>
            </div>
            <div class="row" id="grid" style="display: none;">
                From Location:
                <input type="text" class="form-control grid-input " id="gridLocation" placeholder="">
                <button type="button" class="btn btn-success" id="btnGetRegion">Get Region</button>
                <br />
                <div id="region"></div>
                <br />
                <br />
                <div class="col-md-12">
                    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#saveModal" id="btnSaveGrid">Save Grid</button>
                    <button type="button" class="btn btn-danger" id="btnCancelGrid">Cancel</button>
                </div>
            </div>
            <br />
            <div class="row">
                <div class="col-md-12">
                    <div id="mapPlotting"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div id="logsDiv">
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- /container -->
    <div class="modal fade" id="saveModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Save Grid</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <label class="control-label col-md-3">
                            Enter Region: 
                        </label>
                        <div class="col-md-8">
                            <input type="text" class="form-control" placeholder="">
                        </div>
                    </div>
                    <br />
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCKzGKaXgXZRBipY2QlNWMNBEmVdbTf5mU&libraries=drawing&callback=initMap">
    </script>

    <script>
        // Plot 
        function initMap(mapType) {
            console.log(mapType)
            if (mapType == "plot") {
                var map = new google.maps.Map(document.getElementById('mapPlotting'), {
                    zoom: 6,
                    center: { lat: -33.9, lng: 151.2 }
                });
                getMarkers(map);
            } else if (mapType == "trip") {
                var map = new google.maps.Map(document.getElementById('mapPlotting'), {
                    zoom: 6,
                    center: { lat: -33.9, lng: 151.2 }
                });
                setDirections(map);
            } else if (mapType == "grid") {
                var map = new google.maps.Map(document.getElementById('mapPlotting'), {
                    zoom: 6,
                    center: { lat: -33.9, lng: 151.2 }
                });
                getPolygon(map);
                grid(map);
            }
        }

        // Directions 

        function setDirections(map) {
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer;
            var service = new google.maps.DistanceMatrixService;
            directionsDisplay.setMap(map);

            var onChangeHandler = function () {
                calculateAndDisplayRoute(service, directionsService, directionsDisplay);
            };
            document.getElementById('btnMapTrip').addEventListener('click', onChangeHandler);
        }

        function calculateAndDisplayRoute(service, directionsService, directionsDisplay) {
            var frm = document.getElementById('fromLocation').value;
            var to = document.getElementById('toLocation').value;
            var latfrm = document.getElementById('fromLatLong').value;
            var latto = document.getElementById('toLatLong').value;
            var origin = "";
            var dest = ""
            if (frm == "" && to == "" && latfrm == "" && latto == "") {
                alert("Please Enter Locations");
                return false;
            } else if (frm != "" && to != "") {
                origin = frm;
                dest = to;
            } else if (latfrm != "" && latto != "") {
                origin = latfrm;
                dest = latto;
            } else {
                origin = "";
                dest = "";
            }
            directionsService.route({
                origin: origin,
                destination: dest,
                travelMode: 'DRIVING'
            }, function (response, status) {
                if (status === 'OK') {
                    directionsDisplay.setDirections(response);
                    console.log(response);
                } else {
                    window.alert('Directions request failed due to ' + status);
                    initMap(trip)
                }
            });
            service.getDistanceMatrix({
                origins: [origin],
                destinations: [dest],
                travelMode: 'DRIVING',
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false
            }, function (response, status) {
                if (status !== 'OK') {
                    alert('Error was: ' + status);
                } else {
                    console.log(response);
                    var distance = response.rows[0].elements[0].distance.text;
                    var time = response.rows[0].elements[0].duration.text;
                    $(singleTripTime).html("Expected Trip Time:" + distance + " : " + time)
                }
            });
        }

        // Markers 

        function setMarkers(map, locas) {

            map.setCenter({ lat: locas[0][3], lng: locas[0][4] });
            var shape = {
                coords: [1, 1, 1, 20, 18, 20, 18, 1],
                type: 'poly'
            };

            for (var i = 0; i < locas.length; i++) {
                var infowindow = new google.maps.InfoWindow();
                var image = {
                    //url: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png',
                    url: '/MappingPoc/icons/' + locas[i][6] + '.png',
                    size: new google.maps.Size(50, 50),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(0, 32)
                };
                var locs = locas[i];
                var details = locs[0] + '</br>' + locs[1] + '</br>' + locs[2];
                var myinfowindow = new google.maps.InfoWindow({
                    content: details
                });
                var marker = new google.maps.Marker({
                    position: { lat: locs[3], lng: locs[4] },
                    map: map,
                    icon: image,
                    shape: shape,
                    zIndex: locs[5],
                    infowindow: myinfowindow
                });
                google.maps.event.addListener(marker, 'mouseover', function () {
                    this.infowindow.open(map, this);

                });
                google.maps.event.addListener(marker, 'mouseout', function () {

                    this.infowindow.close(map, this);

                });
                google.maps.event.addListener(marker, 'click', function () {
                    $(selectePin).html("Selected Pin : " + this.infowindow.getContent().split("</br>")[2]);
                });
            }

        }

        function getMarkers(map) {

            var data = [];
            $.ajax({
                url: 'MappingPOCServices.asmx/GetUsersLocation',
                type: 'POST',
                data: {
                    key: "value"
                },
                dataType: "xml",
                async: false
            }).done(function (dataResponse) {
                parse_data = $(dataResponse).find("string").text();
                data = JSON.parse(parse_data);

            });
            //var data = [{"UserID":"8b2001a0-9a10-e611-80c5-00155d5a0823","UserName":"User2","UserIcon":"Icon2","PinLine1":"User 2 Ln1","PinLine2":"Usr2 Ln 2","PinURL":"Usr2 Ln 2","Latitude":"43.6773135","Longitude":"-79.7189257","Mappedon":"2016-08-22T09:32:00"},{"UserID":"8b2001a0-9a10-e611-80c5-00155d5a0824","UserName":"User3","UserIcon":"Icon3","PinLine1":"Usr3 Ln1","PinLine2":"Usr 3 Ln2","PinURL":"Usr 3 Ln2","Latitude":"43.6773175","Longitude":"-79.7189277","Mappedon":"2016-08-22T09:42:00"},{"UserID":"8b2001a0-9a10-e611-80c5-00155d5a0822","UserName":"User1","UserIcon":"Icon1","PinLine1":"Pin Line 1","PinLine2":"PinLine 2","PinURL":"PinLine 2","Latitude":"51.503252","Longitude":"-0.127899","Mappedon":"2016-09-07T17:27:31.77"}]
            breaches = [];
            console.log(data);
            for (i = 0; i < data.length; i++) {
                breaches.push([data[i].PinLine1, data[i].PinLine2, data[i].PinURL, parseFloat(data[i].Latitude), parseFloat(data[i].Longitude), i, data[i].UserIcon])
            }
            setMarkers(map, breaches);
        }

        var regions = {};
        var regions_count = 0;
        function grid(map) {
            document.getElementById('btnGetRegion').addEventListener('click', function () {
                getLoc(document.getElementById('gridLocation').value, map);
            });
            var drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['polygon']
                },
                markerOptions: { icon: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png' },
                polygonOptions: {
                    fillColor: 'red',
                    fillOpacity: 2,
                    strokeWeight: 3,
                    clickable: true,
                    zIndex: 1
                }
            });

            drawingManager.setMap(map);
            google.maps.event.addListener(drawingManager, 'overlaycomplete', function (e) {
                var a = e.overlay.getPaths().getArray()[0].getArray();
                var r = prompt("Enter The Region Name", "Region 1");
                console.log(r);
                geo = [];
                if (r != null || r.trim() != "") {
                    for (i = 0; i < a.length; i++) {
                        console.log(a[i].lat(), a[i].lng());
                        geo.push({ "lat": a[i].lat(), "lng": a[i].lng() });
                    }
                    regions.RegionName = r;
                    regions.LocationInfo = JSON.stringify(geo);
                    setPolygon(regions);

                } else {
                    initMap();
                }
            });

        }

        function getPolygon(map) {
            $.ajax({
                url: 'MappingPOCServices.asmx/GetUserRegions',
                type: 'POST',
                data: {
                    key: "value"
                },
                dataType: "xml",
                async: false
            }).done(function (dataResponse) {
                parse_data = $(dataResponse).find("string").text();
                data = JSON.parse(parse_data);
                showPolygon(map, data);
            });
        }

        function showPolygon(map, data) {
            console.log(data);
            if (data.length) {
                var center = JSON.parse(data[0].LocationInfo);
                map.setCenter(center[0]);
                for (i = 0; i < data.length; i++) {
                    var path = JSON.parse(data[i].LocationInfo);
                    var AVpoly = new google.maps.Polygon({
                        path: path,
                        map: map,
                        strokeColor: "red",
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: "red",
                        fillOpacity: 0.4
                    });
                }
            }
        }

        function setPolygon(data) {
            $.ajax({
                url: 'MappingPOCServices.asmx/SaveUserRegion',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ regionLocationInfo: data }),
                dataType: "json",

                async: false
            }).done(function (dataResponse) {
                alert("Region Saved succesfully");
                initMap("grid");

            });
        }

        function setMarker(map, loc) {

        }

        function getLoc(loc, map) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    if (this.responseText.status = "OK") {
                        data = JSON.parse(this.responseText);
                        if (data.results.length) {
                            location_user = data.results[0].geometry.bounds.northeast;
                            map.setCenter(location_user);
                            var marker = new google.maps.Marker({
                                position: location_user,
                                map: map
                            });
                            console.log(marker);
                            checkReigon(location_user, map)
                        } else {
                            initMap('grid');
                        }
                    }

                } else {
                    initMap('grid');
                }
            };
            xhttp.open("GET", "https://maps.googleapis.com/maps/api/geocode/json?address=" + loc, true);
            xhttp.send();

        }

        function checkReigon(location_user, map) {
            var curPosition = new google.maps.LatLng(location_user.lat, location_user.lng);
            var data;
            $.ajax({
                url: 'MappingPOCServices.asmx/GetUserRegions',
                type: 'POST',
                data: {
                    key: "value"
                },
                dataType: "xml",
                async: false
            }).done(function (dataResponse) {
                parse_data = $(dataResponse).find("string").text();
                data = JSON.parse(parse_data);
            });

            if (data.length) {
                for (i = 0; i < data.length; i++) {
                    var path = JSON.parse(data[i].LocationInfo);
                    var bermudaTriangle = new google.maps.Polygon({ paths: path });
                    if (google.maps.geometry.poly.containsLocation(curPosition, bermudaTriangle)) {
                        $("#region").html("Region:" + data[i].RegionName);
                        break;
                    } else {
                        $("#region").html("Region: NONE ");
                    }
                }
            }

        }
    </script>
    <script>

        function setLogMessage(message) {
            var para = document.createElement("p");
            document.getElementById('locationRef').innerHTML = message;
            var date = new Date();
            var timeMessage = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()
            var node = document.createTextNode(timeMessage + ',' + message);
            para.appendChild(node);

            var element = document.getElementById("logsDiv");
            //element.appendChild(para);
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                setLogMessage("Geolocation is not supported by this browser.");
            }
        }

        function showPosition(position) {
            var message = "Location=" + position.coords.latitude + "," + position.coords.longitude;
            var data = { 'latitude': position.coords.latitude, 'longitude': position.coords.longitude };
            $.ajax({
                url: 'MappingPOCServices.asmx/SaveUserCurrentLocation',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ location: data }),
                dataType: 'json'
            });
            setLogMessage(message);
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    setLogMessage("User denied the request for Geolocation.")
                    break;
                case error.POSITION_UNAVAILABLE:
                    setLogMessage("Location information is unavailable.")
                    break;
                case error.TIMEOUT:
                    setLogMessage("The request to get user location timed out.")
                    break;
                case error.UNKNOWN_ERROR:
                    setLogMessage("An unknown error occurred.")
                    break;
            }
        }

        setInterval(function () {
            getLocation();
        }, 10000);

        $(document).ready(function () {
            $(window).resize(function () {
                var h = $(window).height(),
                offsetTop = 60; // Calculate the top offset
                $('#mapPlotting').css('height', (h - offsetTop));
            }).resize();
            $("#btnMapPlotting").click(function (event) {
                initMap("plot");
                $('#mapPlottingPin').show();
                $('#singleTrip').hide();
                $('#singleTripTime').hide();
                $('#grid').hide();
            });
            $("#btnSingleTrip").click(function (event) {
                initMap("trip");
                $('#singleTrip').show();
                $('#mapPlottingPin').hide();
                $('#singleTripTime').hide();
                $('#grid').hide();
            });
            $("#btnGrid").click(function (event) {
                initMap("grid");
                $('#grid').show();
                $('#singleTrip').hide();
                $('#mapPlottingPin').hide();
            });
            $("#btnMapTrip").click(function (event) {
                $('#singleTripTime').show();
            });
            $("#btnGetRegion").click(function (event) {
                $.getJSON('MappingPOCServices.asmx/GetUserRegions', function (response) {
                    console.log('Data=', response);
                });
            });
            //$("#btnSaveGrid").click(function (event) {
            //    var data = {};
            //    $.ajax({
            //        url: 'MappingPOCServices.asmx/SaveUserRegion',
            //        type: 'POST',
            //        contentType: 'application/json',
            //        data: JSON.stringify({ location: data }),
            //        dataType: 'json'
            //    });
            //});
            $("#btnCancelGrid").click(function (event) {
                alert('Cancel grid click');
            });
        });

        // var noSleep = new NoSleep();
        // noSleep.enable();
    </script>
</body>

</html>